<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Reporte</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/88/88450.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<style>
    :root {
        --azul-profundo: #1E3A8A;
        --azul-claro: #3B82F6;
        --naranja: #F59E0B;
        --verde: #10B981;
        --rojo: #EF4444;
        --gris: #F3F4F6;
        --negro: #111827;
    }

    html,
    body {
        height: 100dvh;
        margin: 0;
        font-family: 'Roboto', sans-serif;
    }

    body {
        display: flex;
        flex-direction: column;
        min-height: 100dvh;
        background: var(--gris);
    }

    header {
        background: var(--azul-profundo);
        color: var(--gris);
    }

    .title-container {
        box-shadow: 0px 2px 5px var(--azul-claro);
        position: relative;
        z-index: 20;
    }

    .btn-atras {
        color: var(--gris);
        text-decoration: none;
    }

    main {
        flex: 1;
        background: var(--gris);
    }

    .btn-container .btn {
        font-weight: 600;
        box-shadow: 0px 1px 4px var(--negro);
    }

    .form-control,
    .form-select {
        border-color: rgba(17, 24, 39, 0.5);
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--azul-profundo);
        box-shadow: 0 0 0 0.25rem rgba(30, 58, 138, 0.3);
    }

    .asterisco {
        color: var(--rojo);
    }
</style>

<body>

    <header>
        <div class="title-container py-4">
            <div class="d-flex align-items-center justify-content-center position-relative">
                <h1 class="text-center fs-2 m-0 fw-bold">Formulario de Reporte</h1>
                <a href="reporteDiferido.html" class="btn-atras position-absolute start-0 mx-2">
                    <i class="bi bi-caret-left-fill fs-1"></i>
                </a>
            </div>
        </div>
    </header>

    <main>
        <div class="form-container container p-4">
            <form id="reporteForm">
                <div class="mb-3">
                    <label class="form-label fw-bold"><i class="bi bi-card-list me-2"></i>Tipo de incidente <span class="asterisco">*</span></label>
                    <select class="form-select" id="tipoIncidente" required>
                        <option value="" selected disabled>Seleccionar...</option>
                        <option value="robo">Robo o hurto</option>
                        <option value="asalto">Asalto a mano armada</option>
                        <option value="violencia">Violencia o agresión física</option>
                        <option value="vandalismo">Vandalismo</option>
                        <option value="acoso">Acoso o intimidación</option>
                        <option value="personas_sospechosas">Personas sospechosas</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="descripcion" class="form-label fw-bold"><i class="bi bi-journal-text me-2"></i>Descripción del incidente <span class="asterisco">*</span></label>
                    <textarea class="form-control" id="descripcion" rows="4"
                        placeholder="Ej: Ví como dos sujetos a bordo de una motolineal roja le arrebataron la cartera a una jóven..."
                        required></textarea>
                </div>
                <div class="mb-3">
                    <label for="ubicacion" class="form-label fw-bold">
                        <i class="bi bi-pin-map-fill me-2"></i>Ubicación <span class="asterisco">*</span>
                    </label>
                    <input class="form-control" type="text" id="ubicacion" placeholder="Ej: Av. Andrés Avelino Cáceres" required>
                </div>
                <div class="mb-3">
                    <label for="referencia" class="form-label fw-bold"><i class="bi bi-geo-alt me-2"></i>Referencia <span class="asterisco">*</span></label>
                    <textarea class="form-control" id="referencia" rows="3"
                        placeholder="Ej: Estacionamiento nuevo del Real Plaza, al lado de Eppo."
                        required></textarea>
                </div>
                <div class="mb-4">
                    <label for="adjuntarImagenes" class="form-label fw-bold"><i class="bi bi-images me-2"></i>Evidencias (opcional)</label>
                    <input class="form-control" type="file" id="adjuntarImagenes" multiple accept="image/*">
                    <div id="image-preview-container" class="mt-2 d-flex flex-wrap"></div>
                </div>
                <div class="form-check form-switch mb-4">
                    <input class="form-check-input" type="checkbox" role="switch" id="reporteAnonimo">
                    <label class="form-check-label fw-bold" for="reporteAnonimo">Reportar de forma anónima</label>
                </div>
                <div class="btn-container">
                    <button type="submit" id="btnEmitir"
                        class="btn btn-danger d-flex align-items-center justify-content-center gap-2 fs-5 w-100">
                         <i class="bi bi-megaphone-fill fs-2"></i>
                        <span id="btnText">Emitir Reporte</span>
                        <div id="btnSpinner" class="spinner-border spinner-border-sm text-light d-none" role="status"></div>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <!-- ⚠️ MODAL DE ERROR GENÉRICO -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered px-4">
            <div class="modal-content rounded-4 border-0 p-3 text-center">
                <i class="bi bi-x-circle text-danger display-1 mb-2"></i>
                <h5 class="fw-bold">Algo salió mal</h5>
                <p class="text-muted" id="errorMsg">Ocurrió un error inesperado.</p>
                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- ⚠️ MODAL FALTA UBICACIÓN -->
    <div class="modal fade" id="locationModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered px-4">
            <div class="modal-content rounded-4 border-0 p-3 text-center">
                <i class="bi bi-map-fill text-warning display-1 mb-2"></i>
                <h5 class="fw-bold">Sin Ubicación</h5>
                <p class="text-muted">Debes seleccionar una ubicación en el mapa primero.</p>
                <a href="reporteDiferido.html" class="btn btn-warning rounded-pill px-4 fw-bold text-dark">Ir al Mapa</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyDal5OulyWHDh_rLNWbrPDIW47eSJZdrhw",
            authDomain: "piuseg-community.firebaseapp.com",
            projectId: "piuseg-community",
            storageBucket: "piuseg-community.firebasestorage.app",
            messagingSenderId: "189220878444",
            appId: "1:189220878444:web:c601a73237b41038f98049",
            measurementId: "G-GV7QX4QFK6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let currentUser = null;
        let userData = { nombres: "", apellidos: "" };

        // Modales
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const locationModal = new bootstrap.Modal(document.getElementById('locationModal'));
        const errorMsgEl = document.getElementById('errorMsg');

        document.addEventListener('DOMContentLoaded', () => {
            // 1. CARGA DE UBICACIÓN Y ESTILOS
            const ubicacionAuto = sessionStorage.getItem('ubicacionDetectada');
            const inputUbicacion = document.getElementById('ubicacion');

            if (ubicacionAuto && inputUbicacion) {
                // Insertamos valor
                inputUbicacion.value = ubicacionAuto;

                // ✅ APLICAMOS TU EFECTO VISUAL SOLICITADO
                inputUbicacion.style.backgroundColor = "#e8f0fe";
                // Añadimos un borde sutil para reforzar que está listo
                inputUbicacion.style.borderColor = "#b3d7ff";
            } else {
                // Mostrar Modal en lugar de alert
                locationModal.show();
            }

            // 2. Auth Check
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    try {
                        const snap = await getDoc(doc(db, "users", user.uid));
                        if(snap.exists()) userData = snap.data();
                    } catch(e) { console.log(e); }
                } else {
                    window.location.href = "login.html";
                }
            });
        });

        // 3. Preview Fotos
        const fileInput = document.getElementById('adjuntarImagenes');
        fileInput.addEventListener('change', function() {
            const container = document.getElementById('image-preview-container');
            container.innerHTML = '';
            Array.from(this.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    container.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        // 4. Enviar
        document.getElementById('reporteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnEmitir');
            const btnText = document.getElementById('btnText');
            const spinner = document.getElementById('btnSpinner');

            btn.disabled = true;
            btnText.textContent = "Procesando...";
            spinner.classList.remove('d-none');

            try {
                // Subir imágenes
                const files = fileInput.files;
                const imageUrls = [];
                if (files.length > 0) {
                    btnText.textContent = "Subiendo fotos...";
                    for (const file of files) {
                        const refStorage = ref(storage, `evidencias/${currentUser.uid}_${Date.now()}_${file.name}`);
                        const snap = await uploadBytes(refStorage, file);
                        const url = await getDownloadURL(snap.ref);
                        imageUrls.push(url);
                    }
                }

                // Guardar en Firestore
                btnText.textContent = "Guardando...";
                const isAnonimo = document.getElementById('reporteAnonimo').checked;
                const autorNombre = isAnonimo ? "Vecino Anónimo" : `${userData.nombres} ${userData.apellidos}`;
                const lat = parseFloat(sessionStorage.getItem('reporteLat'));
                const lng = parseFloat(sessionStorage.getItem('reporteLng'));

                const docRef = await addDoc(collection(db, "reportes"), {
                    tipo: document.getElementById('tipoIncidente').value,
                    descripcion: document.getElementById('descripcion').value,
                    direccion: document.getElementById('ubicacion').value,
                    referencia: document.getElementById('referencia').value,
                    imagenes: imageUrls,
                    es_anonimo: isAnonimo,
                    autor_uid: currentUser.uid,
                    autor_nombre: autorNombre,
                    fecha: serverTimestamp(),
                    lat: lat || null,
                    lng: lng || null
                });

                // Limpieza y Redirección
                sessionStorage.removeItem('ubicacionDetectada');
                sessionStorage.removeItem('reporteLat');
                sessionStorage.removeItem('reporteLng');
                
                window.location.href = `mapa.html?new_id=${docRef.id}`;

            } catch (error) {
                console.error(error);
                errorMsgEl.textContent = error.message;
                errorModal.show(); // Mostrar Modal de Error
                btn.disabled = false;
                btnText.textContent = "Emitir Reporte";
                spinner.classList.add('d-none');
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - PiuSeg Community</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3534/3534124.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/registro.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
</head>

<style>
    :root {
        --azul-profundo: #1E3A8A;
        --azul-claro: #3B82F6;
        --naranja: #F59E0B;
        --verde: #10B981;
        --rojo: #EF4444;
        --gris: #F3F4F6;
        --negro: #111827;
    }

    body {
        background-color: var(--gris);
        font-family: 'Roboto', sans-serif;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .card-auth {
        border: none;
        border-radius: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
        background: white;
        overflow: hidden;
    }

    .header-auth {
        background-color: var(--azul-profundo);
        color: white;
        padding: 2rem 1rem;
        text-align: center;
        border-bottom-left-radius: 2rem;
        border-bottom-right-radius: 2rem;
    }

    .form-control {
        border-radius: 0.8rem;
        padding: 0.8rem 1rem;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .form-control:focus {
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        border-color: #3B82F6;
    }

    .btn-primary-custom {
        background: linear-gradient(90deg, #1E3A8A 0%, #3B82F6 100%);
        border: none;
        border-radius: 0.8rem;
        padding: 0.8rem;
        font-weight: bold;
        width: 100%;
        font-size: 1.1rem;
        transition: all 0.3s;
    }

    .btn-primary-custom:hover {
        background-color: #152c6b;
        transform: translateY(-2px);
    }

    .auth-link {
        color: var(--azul-claro);
        text-decoration: none;
        font-weight: bold;
    }

    .password-toggle {
        cursor: pointer;
        z-index: 10;
    }
</style>

<body>
    <div class="container d-flex justify-content-center">
        <div class="card card-auth">
            <div class="header-auth">
                <i class="bi bi-shield-lock-fill fs-1 mb-2"></i>
                <h3 class="fw-bold m-0">Crear Cuenta</h3>
                <small class="opacity-75">Únete a PiuSeg Community</small>
            </div>
    
            <div class="p-4 pt-5">
                <form id="registroForm">
                    <!-- DNI -->
                    <div class="mb-3 position-relative">
                        <i class="bi bi-person-vcard position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input type="tel" id="dni" class="form-control ps-5" placeholder="DNI (8 dígitos)" maxlength="8"
                            pattern="[0-9]*" required>
                    </div>
    
                    <!-- Nombres -->
                    <div class="mb-3 position-relative">
                        <i class="bi bi-person position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input type="text" id="nombres" class="form-control ps-5" placeholder="Nombres" required>
                    </div>
    
                    <!-- Apellidos -->
                    <div class="mb-3 position-relative">
                        <i class="bi bi-person-fill position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input type="text" id="apellidos" class="form-control ps-5" placeholder="Apellidos" required>
                    </div>
    
                    <!-- Contraseña con Ojo -->
                    <div class="mb-4 position-relative">
                        <i class="bi bi-key position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                        <input type="password" id="password" class="form-control ps-5 pe-5"
                            placeholder="Contraseña (mín 6 caracteres)" minlength="6" required>
                        <!-- Icono de Ojo -->
                        <i class="bi bi-eye-slash position-absolute top-50 end-0 translate-middle-y me-3 text-secondary password-toggle"
                            id="togglePassword"></i>
                    </div>
    
                    <button type="submit" id="btnRegistrar" class="btn btn-primary-custom text-white mb-3">
                        <span id="btnText">Registrarse</span>
                        <div id="btnSpinner" class="spinner-border spinner-border-sm text-light d-none" role="status"></div>
                    </button>
    
                    <div class="text-center mt-3">
                        <small class="text-muted">¿Ya tienes cuenta?</small>
                        <a href="login.html" class="auth-link">Inicia Sesión aquí</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ⚠️ MODAL DE ERROR -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered px-4">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-body text-center py-4">
                    <div class="mb-3">
                        <i class="bi bi-exclamation-circle text-warning display-1"></i>
                    </div>
                    <h5 class="modal-title fw-bold mb-2">Atención</h5>
                    <p class="text-muted mb-4" id="modalErrorMessage">Ocurrió un error inesperado.</p>
                    <button type="button" class="btn btn-primary-custom text-white px-4"
                        data-bs-dismiss="modal">Entendido</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
        crossorigin="anonymous"></script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDal5OulyWHDh_rLNWbrPDIW47eSJZdrhw",
            authDomain: "piuseg-community.firebaseapp.com",
            projectId: "piuseg-community",
            storageBucket: "piuseg-community.firebasestorage.app",
            messagingSenderId: "189220878444",
            appId: "1:189220878444:web:c601a73237b41038f98049",
            measurementId: "G-GV7QX4QFK6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Helpers
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');
        const form = document.getElementById('registroForm');
        const btn = document.getElementById('btnRegistrar');
        const spinner = document.getElementById('btnSpinner');
        const btnText = document.getElementById('btnText');
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const errorMsgEl = document.getElementById('modalErrorMessage');

        function showError(msg) {
            errorMsgEl.textContent = msg;
            errorModal.show();
        }

        togglePassword.addEventListener('click', function () {
            // Alternar tipo de input
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            // Alternar icono
            this.classList.toggle('bi-eye');
            this.classList.toggle('bi-eye-slash');
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            btn.disabled = true;
            btnText.textContent = "Creando cuenta...";
            spinner.classList.remove('d-none');

            const dni = document.getElementById('dni').value;
            const nombres = document.getElementById('nombres').value;
            const apellidos = document.getElementById('apellidos').value;
            const password = document.getElementById('password').value;

            if (dni.length !== 8) {
                showError("El DNI debe tener exactamente 8 dígitos.");
                resetBtn();
                return;
            }

            const fakeEmail = `${dni}@piuseg.community`;

            try {
                // 1. Crear usuario
                const userCredential = await createUserWithEmailAndPassword(auth, fakeEmail, password);
                const user = userCredential.user;

                // 2. Guardar datos en Firestore
                await setDoc(doc(db, "users", user.uid), {
                    dni: dni,
                    nombres: nombres,
                    apellidos: apellidos,
                    fechaRegistro: serverTimestamp()
                });

                // 3. CERRAR SESIÓN INMEDIATAMENTE
                // (Para que no entre directo, sino que vaya al login)
                await signOut(auth);

                // 4. Redirigir al Login con parámetro de éxito
                window.location.href = "login.html?registered=true";

            } catch (error) {
                console.error("Error:", error);
                let msg = "Error en el registro: " + error.message;
                if (error.code === 'auth/email-already-in-use') msg = "Este DNI ya está registrado.";
                if (error.code === 'auth/weak-password') msg = "Contraseña muy débil (mín 6 caracteres).";

                showError(msg);
                resetBtn();
            }
        });

        function resetBtn() {
            btn.disabled = false;
            btnText.textContent = "Registrarse";
            spinner.classList.add('d-none');
        }
    </script>

</body>

</html>